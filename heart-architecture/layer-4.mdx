---
title: "Layer 4: Accounting Ledger"
description: "Single source of truth for every transaction. Fully traceable. Tamper-proof."
---


Layer 4 acts as the accounting layer, capturing every transaction, state change, and event generated by agents or triggered by Mage’s orchestration engine. It provides a verifiable audit trail, enforces transaction integrity, and supports real-time monitoring across all payment flows.

This layer ensures agents, developers, and regulators can trust what happened, when, and why with zero ambiguity.

**All records are stored on a blockchain-backed, append-only ledger to ensure immutability and tamper-proof transparency.**

---

### **Core Components**

| **Component** | **Description** |
| --- | --- |
| **Transaction Monitor** | Real-time tracking of all agent-triggered payment activity with event logging. |
| **Status Manager** | State machine that tracks lifecycle status (initiated, pending, completed, etc.). |
| **Notification Service** | Multi-channel webhooks for payment status updates, retries, and errors. |
| **Audit Trail** | Immutable, blockchain-backed ledger for compliance-grade history and reconciliation. |

---

### **Use Cases & Capabilities**

- **Agent accountability**: Every action is linked to an agent and their permissioned access scope.
- **Repudiation protection**: Agents or users can’t deny triggering an approved transaction; Mage logs both the intent and final state.
- **External reconciliation**: Syncs with external systems like ERP, compliance dashboards, or treasury platforms.
- **Payment observability**: Real-time dashboards for finance and ops teams to view flow of funds, agent behavior, and retry loops.

---

### **How It Works (Simplified)**

- Once Layer 3 executes a transfer, Layer 4 logs the full transaction context, who triggered it, what was approved, how it moved, and what the result was.
- Mage assigns every transaction a globally unique ID and links it to all relevant metadata (agent, org, policy, rail used).
- Any retries, failures, or manual approvals are also recorded with timestamps.
- The ledger cannot be edited or erased, and every event is signed for integrity.

---

### **Example: E-Commerce Checkout**
<br></br>

| Event | Ledger Record (Backend) |
| --- | --- |
| Agent initiates $25 checkout | Scoped access granted, transaction ID created |
| Policy engine approves | Approval context (limits, agent ID, merchant) logged |
| Virtual card issued | Card metadata (BIN, cap, expiry, merchant whitelist) linked to ledger |
| Mage triggers headless checkout | Session details + merchant response saved |
| Merchant processes card payment | Status: payment_submitted; PSP response captured |
| Checkout succeeds | Status: payment_processed; virtual card revoked |
| Ledger updated | Event immutably stored with timestamp, org ID, and full audit trace |
| Webhook sent | Developer notified via Notification Service |




